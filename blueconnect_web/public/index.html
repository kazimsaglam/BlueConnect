<!DOCTYPE html>
<html lang="tr" data-bs-theme="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BlueConnect Panel</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root{
            --bc-primary:#0d6efd;
            --bc-text:#f1f1f1;
            --bc-danger:#e74c3c;
            --bc-info:#3498db;
        }
        body{background:#1a1a1a;color:var(--bc-text);}h1,h5{color:var(--bc-text);}
        .card{border-radius:14px;background:linear-gradient(135deg,#2a2a2a,#343434);box-shadow:0 6px 12px rgba(0,0,0,.35);}        
        .sensor-value{font-size:1.4rem;font-weight:700;}
        #chart-container{height:400px;}
        .device-card.alert{background:rgba(231,76,60,.18);border-left:5px solid var(--bc-danger);animation:blink 1s infinite alternate;}
        @keyframes blink{from{background:rgba(231,76,60,.18);}to{background:rgba(231,76,60,.32);} }
        table thead th{color:var(--bc-primary);}table tbody tr:nth-child(even){background:rgba(255,255,255,.04);}        
        .filter-sm .form-select,.filter-sm .form-control{padding:.25rem .5rem;font-size:.875rem;height:calc(1.5em + .5rem + 2px);}        
    </style>
</head>
<body class="container py-4">
    <!-- Üst bar -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3 filter-sm">
        <h1 class="h3 m-0"><i class="fas fa-microchip me-2"></i>BlueConnect Sensör Paneli</h1>
        <div class="d-flex flex-column flex-sm-row gap-2 w-100 w-md-auto">
            <select id="device-filter" class="form-select" onchange="updateAll()">
                <option value="">Tüm Cihazlar</option>
            </select>
            <input type="date" id="date-filter" class="form-control" onchange="updateAll()">
        </div>
    </div>

    <div class="row g-4">
        <!-- Anlık veriler -->
        <div class="col-md-4">
            <div class="card p-3 h-100">
                <h5 class="mb-3"><i class="fas fa-clock me-2"></i>Anlık Veriler</h5>
                <div id="realtime-data"></div>
            </div>
        </div>

        <!-- Grafik -->
        <div class="col-md-8">
            <div class="card p-3 h-100">
                <h5 class="mb-3"><i class="fas fa-chart-line me-2"></i>Geçmiş Veri Analizi</h5>
                <div id="chart-container"><canvas id="sensor-chart"></canvas></div>
            </div>
        </div>

        <!-- Tablo -->
        <div class="col-12">
            <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-column flex-sm-row gap-2">
                    <h5 class="mb-0"><i class="fas fa-table me-2"></i>Veri Geçmişi</h5>
                    <button class="btn btn-success d-inline-flex align-items-center gap-2" onclick="exportTableToCSV()">
                        <i class="fas fa-file-csv"></i><span>CSV İndir</span>
                    </button>
                </div>
                <table class="table table-hover mb-0" id="history-table">
                    <thead>
                        <tr><th>Cihaz</th><th>Sıcaklık (°C)</th><th>Nem (%)</th><th>Tarih & Saat</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Kitaplıklar -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <script>
        /* =================== YARDIMCI FONKSIYONLAR =================== */
        // Sunucudan gelen UTC zamanı (ISO string) lokal saate -3h düzelt (Istanbul -> UTC+3)
        const localTime = ts => new Date(new Date(ts).getTime() - 3*60*60*1000);

        // Basit fetch sarmalı – hata alırsak boş dizi/nesne döner
        const fetchData = async url => {
            try{
                const res = await fetch(url);
                return await res.json();
            }catch(err){
                console.error('[FETCH ERROR]',err);
                return Array.isArray(url)?[]:{};
            }
        };

        /* =================== CHART.JS =================== */
        const ctx = document.getElementById('sensor-chart').getContext('2d');
        const gTemp = ctx.createLinearGradient(0,0,0,400);
        gTemp.addColorStop(0,'rgba(231,76,60,.45)');
        gTemp.addColorStop(1,'rgba(231,76,60,.05)');
        const gHum  = ctx.createLinearGradient(0,0,0,400);
        gHum.addColorStop(0,'rgba(52,152,219,.45)');
        gHum.addColorStop(1,'rgba(52,152,219,.05)');

        const chart = new Chart(ctx,{
            type:'line',
            data:{datasets:[
                {label:'Sıcaklık (°C)',borderColor:'#e74c3c',backgroundColor:gTemp,borderWidth:2,tension:.3,pointRadius:0,fill:true,data:[]},
                {label:'Nem (%)',      borderColor:'#3498db',backgroundColor:gHum ,borderWidth:2,tension:.3,pointRadius:0,fill:true,data:[]}
            ]},
            options:{
                responsive:true,maintainAspectRatio:false,
                interaction:{intersect:false,mode:'index'},
                plugins:{legend:{labels:{color:'#f1f1f1',boxWidth:12}}},
                scales:{
                    x:{type:'time',time:{unit:'hour',tooltipFormat:'HH:mm'},
                        ticks:{color:'#c0c4d1',autoSkip:true,maxTicksLimit:10,
                               callback:v=>localTime(v).toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'})},
                        grid:{color:'rgba(255,255,255,.05)'}},
                    y:{ticks:{color:'#c0c4d1'},grid:{color:'rgba(255,255,255,.05)'}}
                }
            }
        });

        /* =================== CIHAZ LISTESINI YUKLE =================== */
        async function loadDeviceList(){
            const select = document.getElementById('device-filter');
            select.innerHTML = '<option value="">Tüm Cihazlar</option>';
            const list = await fetchData('/api/device-list');
            list.forEach(dev=>{
                const id   = typeof dev==='string'?dev:(dev.deviceId || dev.id);
                const name = typeof dev==='string'?dev:(dev.deviceName || dev.name || id);
                select.insertAdjacentHTML('beforeend',`<option value="${id}">${name}</option>`);
            });
        }

        /* =================== VERIYI SUNUCUDAN ÇEK & UI'YI GUNCELLE =================== */
        async function updateAll(){
            const deviceId = document.getElementById('device-filter').value;
            const dateStr  = document.getElementById('date-filter').value; // yyyy-MM-dd veya ''

            // Tarih aralığı belirle: filtre yoksa son 24 saat
            let start, end;
            if(dateStr){
                start = new Date(`${dateStr}T00:00:00`);
                end   = new Date(`${dateStr}T23:59:59`);
            }else{
                end   = new Date();
                start = new Date(end.getTime() - 24*60*60*1000);
            }

            // Query parametrelerini oluştur
            const params = new URLSearchParams({
                startDate: start.toISOString(),
                endDate:   end.toISOString()
            });
            if(deviceId) params.append('deviceId',deviceId);

            // Paralel istekler
            const [latest,hist] = await Promise.all([
                fetchData('/api/latest-data'+(deviceId?`?deviceId=${deviceId}`:'')),
                fetchData('/api/historical-data?'+params.toString())
            ]);

            /* ==== ANLIK KARTLAR ==== */
            renderRealtimeCards(latest);

            /* ==== GRAFIK ==== */
            const ordered = Array.isArray(hist)?[...hist].sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp)):[];
            chart.data.datasets[0].data = ordered.map(d=>({x:localTime(d.timestamp),y:d.temperature}));
            chart.data.datasets[1].data = ordered.map(d=>({x:localTime(d.timestamp),y:d.humidity}));
            chart.update('none');

            /* ==== TABLO ==== */
            renderTable(ordered);
        }

        /* ---------------- Realtime Kart Render ---------------- */
        function renderRealtimeCards(dataObj){
            const container = document.getElementById('realtime-data');
            if(!dataObj || Object.keys(dataObj).length===0){
                container.innerHTML = '<p class="text-muted">Veri bulunamadı</p>';
                return;
            }
            container.innerHTML = Object.entries(dataObj).map(([k,d])=>{
                const hot = Number(d.temperature)>30;
                return `<div class="device-card mb-3 p-3 rounded ${hot?'alert':''}">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <h6 class="mb-0">${d.deviceName||k}</h6>
                        <small class="text-muted">${localTime(d.timestamp).toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}</small>
                    </div>
                    <div class="sensor-value text-danger">${d.temperature}°C</div>
                    <div class="sensor-value text-info">${d.humidity}%</div>
                </div>`;
            }).join('');
        }

        /* ---------------- Tablo Render ---------------- */
        function renderTable(list){
            const tbody = document.querySelector('#history-table tbody');
            tbody.innerHTML = list.slice().reverse().map(d=>`
                <tr>
                    <td>${d.deviceName||d.deviceId}</td>
                    <td>${d.temperature}</td>
                    <td>${d.humidity}</td>
                    <td>${localTime(d.timestamp).toLocaleString('tr-TR',{year:'2-digit',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'})}</td>
                </tr>
            `).join('');
        }

        /* =================== CSV EXPORT =================== */
        function exportTableToCSV(fname='veriler.csv'){
            const rows = [...document.querySelectorAll('#history-table tr')];
            const csv  = rows.map(r=>[...r.children].map(c=>`"${c.textContent.trim()}"`).join(',')).join('\n');
            const blob = new Blob([csv],{type:'text/csv'});
            const a    = Object.assign(document.createElement('a'),{href:URL.createObjectURL(blob),download:fname});
            document.body.append(a);a.click();a.remove();
        }

        /* =================== SOKET =================== */
        const socket = io();
        socket.on('new-data',updateAll);

        /* =================== ILK YUKLEME =================== */
        loadDeviceList();
        updateAll();
        setInterval(updateAll,5000); // 5 sn'de bir otomatik güncelle
    </script>
</body>
</html>